<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF åœ°åœ–é…æº–èˆ‡æ¨™è¨»å·¥å…· (Leafletç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: "Microsoft JhengHei", sans-serif; }
        
        /* å·¦å´æ§åˆ¶é¢æ¿ */
        .sidebar {
            width: 320px; background: #f8f9fa; padding: 15px; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; overflow-y: auto; z-index: 1000;
        }
        .sidebar h3 { margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .section { margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 5px; }
        .control-group { margin-bottom: 10px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        button { width: 100%; padding: 8px; margin-top: 5px; cursor: pointer; border: none; border-radius: 3px; color: white; background: #6c757d; }
        button:hover { opacity: 0.9; }
        button.primary { background: #007bff; }
        button.success { background: #28a745; }
        button.danger { background: #dc3545; }
        button.warning { background: #ffc107; color: #333; }
        input[type="range"] { width: 100%; }
        textarea { width: 100%; height: 80px; font-size: 12px; }

        /* å³å´åœ°åœ–å€åŸŸ */
        #map { flex: 1; height: 100%; }

        /* æ ¡æ­£ç”¨çš„æ§åˆ¶é»æ¨£å¼ */
        .handle-icon {
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid white;
            border-radius: 50%;
            cursor: move;
        }
        
        /* ç‹€æ…‹åˆ— */
        .status-bar { font-size: 12px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>ğŸ—ºï¸ åœ°åœ–é…æº–å·¥å…·</h3>

    <div class="section">
        <label>1. ä¸Šå‚³ PDF åœ°åœ–</label>
        <input type="file" id="pdf-input" accept="application/pdf" style="margin-bottom: 10px;">
        
        <div class="control-group">
            <label>PDF é€æ˜åº¦: <span id="opacity-val">0.7</span></label>
            <input type="range" id="opacity-slider" min="0" max="1" step="0.1" value="0.7">
        </div>

        <button id="btn-lock" class="warning" onclick="toggleLock()" disabled>ğŸ”“ é–å®š / è§£é– PDF</button>
        <div class="status-bar">èªªæ˜ï¼šä¸Šå‚³å¾Œï¼Œæ‹–æ‹‰åœ°åœ–ä¸Šçš„ã€Œé»‘è‰²åœ“é»ã€ä¾†å°é½Šè¡—é“ã€‚å°é½Šå¾Œè«‹æŒ‰é–å®šã€‚</div>
    </div>

    <div class="section">
        <label>2. åº§æ¨™è³‡æ–™ (JSON)</label>
        <textarea id="json-input" placeholder='[{"lat": 25.033, "lng": 121.565, "name": "å°åŒ—101", "category": "æ™¯é»"}]'></textarea>
        <button class="primary" onclick="importData()">åŒ¯å…¥è³‡æ–™é»</button>
        <button onclick="addManualMarker()">â• æ‰‹å‹•æ–°å¢ä¸€é» (åœ°åœ–ä¸­å¿ƒ)</button>
        <button class="danger" onclick="clearMarkers()">æ¸…é™¤æ‰€æœ‰é»</button>
    </div>

    <div class="section">
        <label>3. åŒ¯å‡ºèˆ‡å­˜æª”</label>
        <button class="success" onclick="exportPDF()">ğŸ’¾ åŒ¯å‡ºæ¨™è¨» PDF</button>
        <button class="primary" onclick="saveProject()">ğŸ“‚ å„²å­˜å°ˆæ¡ˆ (JSON)</button>
        <button onclick="loadProjectClick()">ğŸ“‚ è¼‰å…¥å°ˆæ¡ˆ (JSON)</button>
        <input type="file" id="project-input" accept=".json" style="display: none;">
    </div>
</div>

<div id="map"></div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let map;
    let pdfOverlay = null;   // Leaflet ImageOverlay
    let pdfDocBytes = null;  // åŸå§‹ PDF Binary
    let boundsHandleNW = null; // å·¦ä¸Šè§’æ§åˆ¶é»
    let boundsHandleSE = null; // å³ä¸‹è§’æ§åˆ¶é»
    let isLocked = false;    // æ˜¯å¦é–å®šç·¨è¼¯
    
    // è³‡æ–™é»å„²å­˜
    // çµæ§‹: { id, lat, lng, name, category, markerRef }
    let markersData = []; 

    // åˆå§‹åŒ– Leaflet åœ°åœ–
    // é è¨­ä½ç½®ï¼šå°åŒ— (ä½¿ç”¨è€…å¯è‡ªè¡Œæ‹–æ‹‰)
    map = L.map('map').setView([25.0330, 121.5654], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // è¨­å®š PDF.js Worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // --- 1. PDF è™•ç†èˆ‡é…æº–é‚è¼¯ ---

    document.getElementById('pdf-input').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // è®€å–æª”æ¡ˆ
        const arrayBuffer = await file.arrayBuffer();
        pdfDocBytes = arrayBuffer;

        // æ¸²æŸ“ç¬¬ä¸€é ç‚ºåœ–ç‰‡
        const loadingTask = pdfjsLib.getDocument(arrayBuffer);
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1);
        
        // è¨­å®šé«˜è§£æåº¦æ¸²æŸ“ (scale 2) ä»¥ç¢ºä¿åœ°åœ–æ¸…æ™°
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({ canvasContext: context, viewport: viewport }).promise;
        const imgUrl = canvas.toDataURL('image/png');

        // è¨ˆç®—åˆå§‹é‚Šç•Œ (æ”¾åœ¨ç›®å‰åœ°åœ–ä¸­å¿ƒï¼Œç¨å¾®ç¸®å°ä¸€é»ä»¥å…æ»¿ç‰ˆ)
        const center = map.getCenter();
        const latOffset = 0.01; // ç´„ 1km
        const lngOffset = 0.01; 
        const initialBounds = [
            [center.lat + latOffset, center.lng - lngOffset], // NorthWest
            [center.lat - latOffset, center.lng + lngOffset]  // SouthEast
        ];

        // ç§»é™¤èˆŠçš„
        if (pdfOverlay) map.removeLayer(pdfOverlay);
        if (boundsHandleNW) map.removeLayer(boundsHandleNW);
        if (boundsHandleSE) map.removeLayer(boundsHandleSE);

        // åŠ å…¥æ–° Overlay
        pdfOverlay = L.imageOverlay(imgUrl, initialBounds, { opacity: 0.7 }).addTo(map);
        
        // å»ºç«‹æ§åˆ¶é» (ç”¨æ–¼æ‰‹å‹•æ ¡æ­£)
        createControlHandles(initialBounds);

        // å•Ÿç”¨æŒ‰éˆ•
        document.getElementById('btn-lock').disabled = false;
        map.fitBounds(initialBounds);
    });

    // å»ºç«‹æ‹–æ‹‰æ§åˆ¶é»
    function createControlHandles(bounds) {
        const icon = L.divIcon({ className: 'handle-icon', iconSize: [12, 12] });

        // å·¦ä¸Šè§’ (NW)
        boundsHandleNW = L.marker(bounds[0], { draggable: true, icon: icon }).addTo(map);
        // å³ä¸‹è§’ (SE)
        boundsHandleSE = L.marker(bounds[1], { draggable: true, icon: icon }).addTo(map);

        // ç›£è½æ‹–æ‹‰äº‹ä»¶
        const updateOverlay = () => {
            const nw = boundsHandleNW.getLatLng();
            const se = boundsHandleSE.getLatLng();
            // æ›´æ–° Overlay ä½ç½®
            pdfOverlay.setBounds([nw, se]);
        };

        boundsHandleNW.on('drag', updateOverlay);
        boundsHandleSE.on('drag', updateOverlay);
    }

    // é€æ˜åº¦èª¿æ•´
    document.getElementById('opacity-slider').addEventListener('input', (e) => {
        const val = e.target.value;
        document.getElementById('opacity-val').innerText = val;
        if (pdfOverlay) pdfOverlay.setOpacity(val);
    });

    // é–å®š/è§£é–
    function toggleLock() {
        if (!pdfOverlay) return;
        isLocked = !isLocked;
        const btn = document.getElementById('btn-lock');
        
        if (isLocked) {
            // é–å®šæ¨¡å¼ï¼šç§»é™¤æ§åˆ¶é»ï¼Œé¿å…èª¤è§¸
            if (boundsHandleNW) map.removeLayer(boundsHandleNW);
            if (boundsHandleSE) map.removeLayer(boundsHandleSE);
            // é–å®šåœ–ç‰‡ä½¿å…¶ä¸å¯äº’å‹• (ç©¿é€é»æ“Šåˆ°åœ°åœ–)
            pdfOverlay.getElement().style.pointerEvents = 'none';
            btn.innerHTML = 'ğŸ”’ å·²é–å®š (é»æ­¤è§£é–)';
            btn.className = 'success';
        } else {
            // è§£é–æ¨¡å¼ï¼šåŠ å›æ§åˆ¶é»
            const bounds = pdfOverlay.getBounds();
            createControlHandles([bounds.getNorthWest(), bounds.getSouthEast()]);
            pdfOverlay.getElement().style.pointerEvents = 'auto';
            btn.innerHTML = 'ğŸ”“ é–å®š / è§£é– PDF';
            btn.className = 'warning';
        }
    }

    // --- 2. è³‡æ–™é»è™•ç†é‚è¼¯ ---

    function addMarkerToMap(lat, lng, name, category, id = null) {
        // æ±ºå®šé¡è‰² (ç°¡å–®ç¯„ä¾‹)
        let color = 'blue';
        if (category === 'å±éšª') color = 'red';
        if (category === 'å¾…ä¿®') color = 'orange';

        // å»ºç«‹ Marker
        // ä½¿ç”¨é è¨­ Iconï¼Œå¦‚æœè¦æ”¹é¡è‰²éœ€æ› Icon Urlï¼Œé€™è£¡å…ˆç”¨æ¨™æº–è—è‰²ï¼Œåƒ…åœ¨ Popup é¡¯ç¤ºé¡åˆ¥
        const marker = L.marker([lat, lng], { draggable: true }).addTo(map);

        const dataId = id || Date.now() + Math.random().toString(16).slice(2);

        // ç¶å®š Popup (ç°¡æ˜“ç·¨è¼¯ä»‹é¢)
        const popupContent = `
            <div style="min-width:150px">
                <label>åç¨±:</label>
                <input type="text" value="${name}" onchange="updateMarkerData('${dataId}', 'name', this.value)" style="width:100%; margin-bottom:5px;">
                <label>é¡åˆ¥:</label>
                <select onchange="updateMarkerData('${dataId}', 'category', this.value)" style="width:100%">
                    <option value="ä¸€èˆ¬" ${category === 'ä¸€èˆ¬' ? 'selected' : ''}>ä¸€èˆ¬</option>
                    <option value="æ™¯é»" ${category === 'æ™¯é»' ? 'selected' : ''}>æ™¯é»</option>
                    <option value="å¾…ä¿®" ${category === 'å¾…ä¿®' ? 'selected' : ''}>å¾…ä¿®</option>
                    <option value="å±éšª" ${category === 'å±éšª' ? 'selected' : ''}>å±éšª</option>
                </select>
                <button class="danger" onclick="removeMarker('${dataId}')" style="margin-top:10px; padding:2px;">åˆªé™¤</button>
            </div>
        `;
        marker.bindPopup(popupContent);

        // å„²å­˜è³‡æ–™
        const dataObj = { id: dataId, lat, lng, name, category, markerRef: marker };
        markersData.push(dataObj);

        // ç›£è½æ‹–æ‹‰çµæŸï¼Œæ›´æ–°è³‡æ–™åº«åº§æ¨™
        marker.on('dragend', (e) => {
            const newPos = e.target.getLatLng();
            const target = markersData.find(d => d.id === dataId);
            if (target) {
                target.lat = newPos.lat;
                target.lng = newPos.lng;
            }
        });

        return marker;
    }

    // å…¨åŸŸå‡½å¼ä¾› Popup å‘¼å«
    window.updateMarkerData = function(id, field, value) {
        const target = markersData.find(d => d.id === id);
        if (target) target[field] = value;
    };

    window.removeMarker = function(id) {
        const idx = markersData.findIndex(d => d.id === id);
        if (idx !== -1) {
            map.removeLayer(markersData[idx].markerRef);
            markersData.splice(idx, 1);
        }
    };

    function importData() {
        const jsonStr = document.getElementById('json-input').value;
        try {
            const data = JSON.parse(jsonStr);
            if (Array.isArray(data)) {
                data.forEach(item => {
                    addMarkerToMap(item.lat, item.lng, item.name || 'æœªå‘½å', item.category || 'ä¸€èˆ¬');
                });
            } else {
                alert('æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯ Array');
            }
        } catch (e) {
            alert('JSON è§£æå¤±æ•—');
        }
    }

    function addManualMarker() {
        const center = map.getCenter();
        addMarkerToMap(center.lat, center.lng, "æ–°åœ°é»", "ä¸€èˆ¬");
    }

    function clearMarkers() {
        if(!confirm("ç¢ºå®šåˆªé™¤æ‰€æœ‰é»ï¼Ÿ")) return;
        markersData.forEach(d => map.removeLayer(d.markerRef));
        markersData = [];
    }

    // --- 3. åŒ¯å‡ºé‚è¼¯ (æ ¸å¿ƒæ•¸å­¸é‹ç®—) ---

    async function exportPDF() {
        if (!pdfDocBytes || !pdfOverlay) return alert("è«‹å…ˆä¸Šå‚³ PDF ä¸¦å®Œæˆé…æº–");
        
        const { PDFDocument, rgb, StandardFonts } = PDFLib;
        const pdfDoc = await PDFDocument.load(pdfDocBytes);
        const page = pdfDoc.getPages()[0]; // è™•ç†ç¬¬ä¸€é 
        const { width: pdfW, height: pdfH } = page.getSize();

        // å–å¾—ç›®å‰ PDF Overlay åœ¨åœ°åœ–ä¸Šçš„é‚Šç•Œ (ç¶“ç·¯åº¦)
        const bounds = pdfOverlay.getBounds();
        const north = bounds.getNorth();
        const south = bounds.getSouth();
        const east = bounds.getEast();
        const west = bounds.getWest();

        // è¼‰å…¥å­—å‹ (è‹±æ–‡ç”¨æ¨™æº–ï¼Œä¸­æ–‡è‹¥ç„¡åµŒå…¥å­—å‹æœƒè®Šäº‚ç¢¼ï¼Œå»ºè­°ç”¨åœ–å½¢æˆ–åƒ…è‹±æ–‡)
        // é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å…ˆç”¨æ¨™æº– Helvetica å­—å‹ (ä¸æ”¯æ´ä¸­æ–‡é¡¯ç¤º)
        // **è‹¥éœ€ä¸­æ–‡ï¼Œé€šå¸¸éœ€ä½¿ç”¨ setContent ç´”æ–‡å­—æ¨™è¨˜æˆ–åµŒå…¥å¤§å‹å­—é«”æª”**
        // é€™è£¡æˆ‘å€‘ç”¨ "Annotation" (Adobe è¨»é‡‹åŠŸèƒ½)ï¼Œå¤§éƒ¨åˆ†é–±è®€å™¨èƒ½ç”¨ç³»çµ±å­—å‹é¡¯ç¤ºä¸­æ–‡å…§å®¹
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

        for (const p of markersData) {
            // æª¢æŸ¥é»æ˜¯å¦åœ¨ç¯„åœå…§
            if (p.lat > north || p.lat < south || p.lng > east || p.lng < west) continue;

            // --- åº§æ¨™è½‰æ› (ç¶“ç·¯åº¦ -> PDF åº§æ¨™) ---
            // 1. è¨ˆç®—è©²é»åœ¨ç¶“ç·¯åº¦ç¯„åœå…§çš„ã€Œç™¾åˆ†æ¯”ä½ç½®ã€(0.0 ~ 1.0)
            const ratioX = (p.lng - west) / (east - west);
            const ratioY = (p.lat - south) / (north - south); // PDF Y è»¸é€šå¸¸å‘ä¸Šï¼ŒLeaflet Lat ä¹Ÿæ˜¯å‘ä¸Šï¼Œæ–¹å‘ä¸€è‡´

            // 2. æ˜ å°„åˆ° PDF å°ºå¯¸
            const pdfX = ratioX * pdfW;
            const pdfY = ratioY * pdfH;

            // 3. å»ºç«‹è¨»é‡‹ (Text Annotation / Sticky Note)
            // é€™æ¨£åœ¨ Adobe Reader é»å…©ä¸‹æœƒçœ‹åˆ°å…§å®¹
            
            // ç‚ºäº†è¦–è¦ºæ˜é¡¯ï¼Œæˆ‘å€‘ç•«ä¸€å€‹å°ç´…åœˆ (Square Annotation ç•¶ä½œé»)
            const dotSize = 10;
            const squareAnnot = pdfDoc.context.obj({
                Type: 'Annot',
                Subtype: 'Square',
                Rect: [pdfX - 5, pdfY - 5, pdfX + 5, pdfY + 5], // 10x10 çš„é»
                C: [1, 0, 0], // ç´…è‰²
                IC: [1, 0, 0], // å¡«å……ç´…è‰²
                Contents: PDFLib.PDFString.of(`${p.name} (${p.category})`), // è¨»é‡‹å…§å®¹ (éƒ¨åˆ†é–±è®€å™¨æ”¯æ´ç³»çµ±å­—å‹é¡¯ç¤ºä¸­æ–‡)
                T: PDFLib.PDFString.of(p.category) // æ¨™é¡Œ
            });
            
            // åŠ å…¥æ–‡å­—æ¨™ç±¤ (FreeText) - æ³¨æ„ï¼šé€™åœ¨ PDF è£¡å¦‚æœä¸åµŒå­—å‹ï¼Œä¸­æ–‡æœƒæ˜¯äº‚ç¢¼
            // ç‚ºäº†ä¿éšªï¼Œæˆ‘å€‘åƒ…åŒ¯å‡ºå¯ç·¨è¼¯çš„ "è¨»é‡‹ç‰©ä»¶"
            
            addAnnotToPage(page, squareAnnot, pdfDoc);
        }

        const pdfOutBytes = await pdfDoc.save();
        downloadBlob(pdfOutBytes, 'georeferenced_map.pdf', 'application/pdf');
    }

    function addAnnotToPage(page, annot, pdfDoc) {
        const annotsRef = page.node.lookup(pdfDoc.context.register(pdfDoc.context.obj('Annots'))) || pdfDoc.context.obj([]);
        if (!page.node.Annots()) {
            page.node.set(PDFLib.PDFName.of('Annots'), pdfDoc.context.register([annot]));
        } else {
            page.node.Annots().push(annot);
        }
    }

    // --- å„²å­˜èˆ‡è¼‰å…¥å°ˆæ¡ˆ (JSON) ---

    function saveProject() {
        if (!pdfOverlay) return alert("ç„¡é…æº–è³‡æ–™");
        const bounds = pdfOverlay.getBounds();
        
        // æˆ‘å€‘ä¸å­˜ PDF æœ¬èº« (å¤ªå¤§)ï¼Œåªå­˜è¨­å®š
        // ä½¿ç”¨è€…ä¸‹æ¬¡éœ€é‡æ–°é¸å–åŒä¸€å€‹ PDF
        const project = {
            bounds: {
                north: bounds.getNorth(),
                south: bounds.getSouth(),
                east: bounds.getEast(),
                west: bounds.getWest()
            },
            markers: markersData.map(d => ({
                lat: d.lat, lng: d.lng, name: d.name, category: d.category, id: d.id
            }))
        };
        
        const blob = new Blob([JSON.stringify(project, null, 2)], {type : 'application/json'});
        downloadBlob(blob, 'project_data.json', 'application/json');
    }

    function loadProjectClick() {
        document.getElementById('project-input').click();
    }

    document.getElementById('project-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const project = JSON.parse(evt.target.result);
                // 1. é‚„åŸé‚Šç•Œ (å¦‚æœæœ‰ Overlay)
                if (pdfOverlay && project.bounds) {
                    const b = project.bounds;
                    const newBounds = [[b.north, b.west], [b.south, b.east]];
                    pdfOverlay.setBounds(newBounds);
                    // å¦‚æœåœ¨è§£é–æ¨¡å¼ï¼Œä¹Ÿè¦æ›´æ–°æ‰‹æŠŠ
                    if (!isLocked) {
                        map.removeLayer(boundsHandleNW);
                        map.removeLayer(boundsHandleSE);
                        createControlHandles([L.latLng(b.north, b.west), L.latLng(b.south, b.east)]);
                    }
                    map.fitBounds(newBounds);
                } else if (!pdfOverlay) {
                    alert("è«‹å…ˆä¸Šå‚³åŸå§‹ PDFï¼Œæ‰èƒ½å¥—ç”¨é‚Šç•Œè¨­å®š");
                }

                // 2. é‚„åŸé»ä½
                if (project.markers) {
                    clearMarkers(); // å…ˆæ¸…ç©ºç›®å‰çš„
                    markersData = []; // é‡ç½®
                    project.markers.forEach(p => {
                        addMarkerToMap(p.lat, p.lng, p.name, p.category, p.id);
                    });
                }
            } catch (err) {
                console.error(err);
                alert("è¼‰å…¥å¤±æ•—");
            }
        };
        reader.readAsText(file);
    });

    function downloadBlob(data, filename, type) {
        const blob = new Blob([data], { type: type });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }

</script>

</body>
</html>
